name: Publish Release

on:
  push:
    tags:
      - 'v*'
      - 'V*'
      - '[0-9]*'

permissions:
  contents: write

jobs:
  build-and-release:
    name: Build for ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    # FIX 1: Wir zwingen alle Systeme (auch Windows) Bash zu nutzen.
    # Das fixt den "ParserError" mit den Backslashes \
    defaults:
      run:
        shell: bash

    strategy:
      fail-fast: false
      matrix:
        include:
          - os: windows-latest
            rid: win-x64
          - os: ubuntu-latest
            rid: linux-x64
          - os: macos-latest
            rid: osx-arm64

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET 9
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 9.0.x

      - name: Install Velopack (vpk)
        run: dotnet tool install -g vpk

      - name: Install Dependencies (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y libfuse2

      - name: Clean Version String
        run: |
          TAG_NAME=${GITHUB_REF#refs/tags/}
          CLEAN_VERSION=$(echo "$TAG_NAME" | sed 's/^[vV]//')
          echo "Processing Version: $CLEAN_VERSION"
          echo "VERSION=$CLEAN_VERSION" >> $GITHUB_ENV

      - name: Publish DotNet
        # FIX 2: Pfad zur csproj angepasst! 
        # Falls dein Repo-Root anders ist, pass "EasyExtractCrossPlatform/" an.
        run: |
          dotnet publish EasyExtractCrossPlatform/EasyExtractCrossPlatform.csproj \
            -c Release \
            -r ${{ matrix.rid }} \
            --self-contained \
            -p:Version=${{ env.VERSION }} \
            -o publish_output

      # --- WINDOWS PACKING ---
      - name: Pack with Velopack (Windows)
        if: runner.os == 'Windows'
        run: |
          vpk pack -u EasyExtractCrossPlatform -v ${{ env.VERSION }} -p publish_output -o release_output --mainExe EasyExtractCrossPlatform.exe

      # --- LINUX PACKING ---
      - name: Pack with Velopack (Linux)
        if: runner.os == 'Linux'
        run: |
          vpk pack -u EasyExtractCrossPlatform -v ${{ env.VERSION }} -p publish_output -o release_output --mainExe EasyExtractCrossPlatform

      # --- MAC PACKING ---
      - name: Pack with Velopack (macOS)
        if: runner.os == 'macOS'
        run: |
          vpk pack -u EasyExtractCrossPlatform -v ${{ env.VERSION }} -p publish_output -o release_output --mainExe EasyExtractCrossPlatform

      - name: Upload Release Assets
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: release_output/*
          draft: true
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}